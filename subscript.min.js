const e=e=>e>=48&&e<=57,r=e=>e>=65&&e<=90||e>=97&&e<=122||36==e||95==e||e>=192,t=t=>r(t)||e(t),n=e=>e<=32,s=e=>!quotes[String.fromCharCode(e)],a=(e,r=binary,t,n,s)=>{for(s=r.length;s--;)if(n=r[s][e])return t?n:s+1},o=(e,r)=>Array.isArray(e)&&e.length&&e[0]&&(r?e[0]===r:"string"==typeof e[0]||o(e[0])),l=e=>e.length<2?e[0]:e,u=Symbol.for("nil");export const literals={true:!0,false:!1,null:null},blocks={"(":")","[":"]"},quotes={'"':'"'},comments={},unary=[{"!":e=>!e,"+":e=>+e,"-":e=>-e,"++":e=>++e,"--":e=>--e},{}],binary=[{"||":(...e)=>e.some(Boolean)},{"&&":(...e)=>e.every(Boolean)},{"|":(e,r)=>e|r},{"^":(e,r)=>e^r},{"&":(e,r)=>e&r},{"!=":(e,r)=>e!=r,"==":(e,r)=>e==r},{">=":(e,r)=>e>=r,">":(e,r)=>e>r,"<=":(e,r)=>e<=r,"<":(e,r)=>e<r},{">>>":(e,r)=>e>>>r,">>":(e,r)=>e>>r,"<<":(e,r)=>e<<r},{"+":(...e)=>e.reduce(((e,r)=>e+r)),"-":(...e)=>e.reduce(((e,r)=>e-r))},{"%":(...e)=>e.reduce(((e,r)=>e%r)),"/":(...e)=>e.reduce(((e,r)=>e/r)),"*":(...e)=>e.reduce(((e,r)=>e*r))},{".":(...e)=>e.reduce(((e,r)=>e?e[r]:e))}],transforms={"(":e=>e.length<3?e[1]:e},transform=(e,r)=>(r=o(e)&&transforms[e[0]])?r(e):e,parse=(i,f=0,c=i.length)=>{const p=()=>i.charAt(f),h=()=>i.charCodeAt(f),g=e=>(e=>{throw new Error(e)})(e+" at character "+f),y=(e,r=h())=>{for(;f<c&&e(r);)r=i.charCodeAt(++f);return f},m=e=>i.slice(f,y(e)),d=e=>{let r,t=[];for(;f<c&&(r=p())!==e;)";"===r||","===r?f++:(t.push(v()),y(n));return e&&f++,t},b=(e=binary,r,t=3)=>{for(y(n);!a(r=i.substr(f,t--),e);)if(!t)return;return f+=r.length,r},v=()=>{let e,r,t,n,s,o,l,i;if(u!=(s=x())){if(!(r=b()))return s;for(u==(o=x())&&g("Expected expression after "+r),n=[s,[r,a(r)||0],o];(i=b())&&(t=a(i));){for(;n.length>2&&n[n.length-2][1]>=t;)o=n.pop(),r=n.pop()[0],s=n.pop(),n.push([r,s,o]);u==(e=x())&&g("Expected expression after "+i),n.push([i,t],e)}for(l=n.length-1,e=n[l];l>1;)e=[n[l-1][0],n[l-2],e],l-=2;return e}},x=()=>{let a,i,c,v;if(y(n),a=h(),i=p(),e(a)||"."===i)v=new Number(A());else if(s(a))if(blocks[i])f++,w=[i,...d(blocks[i])],v=(C=o(w)&&transforms[w[0]])?C(w):w;else{if(!r(a))return(c=b(unary))?u==(v=x())?g("missing unaryOp argument"):[c,v]:u;v=(v=m(t))in literals?literals[v]:v}else f++,v=new String(m(s)),f++;for(var w,C;y(n),i=p(),"."===i||"["===i||"("===i;)f++,y(n),"["===i?(v=[".",v]).push(l(d("]"))):"("===i?v=[v,...d(")")]:"."===i&&(v=[".",v]).push(m(t));return v},A=()=>{let r="",t=p();return r+=m(e),"."===p()&&(r+=i.charAt(f++)+m(e)),t=p(),"e"!==t&&"E"!==t||(r+=t,f++,t=p(),"+"!==t&&"-"!==t||(r+=t,f++),r+=m(e)),r};return l(d())},evaluate=(e,r={},t,n)=>o(e)?"."==(t=e[0])?a(t,binary,!0)(evaluate(e[1],r),...e.slice(2)):("string"==typeof t&&(n=a(t,e.length<3?unary:binary,!0)),"function"!=typeof(t=n||evaluate(t,r))?t:t.call(...e.map((e=>evaluate(e,r))))):e&&"string"==typeof e?quotes[e[0]]?e.slice(1,-1):"@"===e[0]?e.slice(1):e in r?r[e]:e:e;export default e=>(e="string"==typeof e?parse(e):e,r=>evaluate(e,r));
