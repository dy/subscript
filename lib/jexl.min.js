var e,t,r,n=(e=function(e){e.exports=function(e){return e&&e.__esModule?e:{default:e}}},e(r={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&r.path)}},r.exports),r.exports);var a=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e};var i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function o(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var s=function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e};var u=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n};var l=function(e){if(Array.isArray(e))return u(e)};var c=function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)};var p=function(e,t){if(e){if("string"==typeof e)return u(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?u(e,t):void 0}};var h=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var f=n((function(e){return l(e)||c(e)||p(e)||h()})),v={functions:"Jexl Function",transforms:"Transform"},y={ArrayLiteral:function(e){return this.evalArray(e.value)},BinaryExpression:function(e){var t=this,r=this._grammar.elements[e.operator];if(r.evalOnDemand){var n=function(e){return{eval:function(){return t.eval(e)}}};return r.evalOnDemand(n(e.left),n(e.right))}return this.Promise.all([this.eval(e.left),this.eval(e.right)]).then((function(e){return r.eval(e[0],e[1])}))},ConditionalExpression:function(e){var t=this;return this.eval(e.test).then((function(r){return r?e.consequent?t.eval(e.consequent):r:t.eval(e.alternate)}))},FilterExpression:function(e){var t=this;return this.eval(e.subject).then((function(r){return e.relative?t._filterRelative(r,e.expr):t._filterStatic(r,e.expr)}))},Identifier:function(e){return e.from?this.eval(e.from).then((function(t){if(null!=t)return Array.isArray(t)&&(t=t[0]),t[e.value]})):e.relative?this._relContext[e.value]:this._context[e.value]},Literal:function(e){return e.value},ObjectLiteral:function(e){return this.evalMap(e.value)},FunctionCall:function(e){var t=v[e.pool];if(!t)throw new Error("Corrupt AST: Pool '".concat(e.pool,"' not found"));var r=this._grammar[e.pool][e.name];if(!r)throw new Error("".concat(t," ").concat(e.name," is not defined."));return this.evalArray(e.args||[]).then((function(e){return r.apply(void 0,(0,f.default)(e))}))},UnaryExpression:function(e){var t=this;return this.eval(e.right).then((function(r){return t._grammar.elements[e.operator].eval(r)}))}},_=n(i),d=n(s),m=function(){function e(t,r,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Promise;(0,_.default)(this,e),this._grammar=t,this._context=r||{},this._relContext=n||this._context,this.Promise=a}return(0,d.default)(e,[{key:"eval",value:function(e){var t=this;return this.Promise.resolve().then((function(){return y[e.type].call(t,e)}))}},{key:"evalArray",value:function(e){var t=this;return this.Promise.all(e.map((function(e){return t.eval(e)})))}},{key:"evalMap",value:function(e){var t=this,r=Object.keys(e),n={},a=r.map((function(r){return t.eval(e[r])}));return this.Promise.all(a).then((function(e){return e.forEach((function(e,t){n[r[t]]=e})),n}))}},{key:"_filterRelative",value:function(t,r){var n=this,a=[];return Array.isArray(t)||(t=void 0===t?[]:[t]),t.forEach((function(t){var i=new e(n._grammar,n._context,t,n.Promise);a.push(i.eval(r))})),this.Promise.all(a).then((function(e){var r=[];return e.forEach((function(e,n){e&&r.push(t[n])})),r}))}},{key:"_filterStatic",value:function(e,t){return this.eval(t).then((function(t){return"boolean"==typeof t?t?e:void 0:e[t]}))}}]),e}(),b=n(i),x=n(s),g=/^-?(?:(?:[0-9]*\.[0-9]+)|[0-9]+)$/,k=/^[a-zA-Zа-яА-Я_\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u00FF$][a-zA-Zа-яА-Я0-9_\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u00FF$]*$/,S=/\\\\/,O=/^\s*$/,E=["'(?:(?:\\\\')|[^'])*'",'"(?:(?:\\\\")|[^"])*"',"\\s+","\\btrue\\b","\\bfalse\\b"],w=["[a-zA-Zа-яА-Я_À-ÖØ-öø-ÿ\\$][a-zA-Z0-9а-яА-Я_À-ÖØ-öø-ÿ\\$]*","(?:(?:[0-9]*\\.[0-9]+)|[0-9]+)"],j=["binaryOp","unaryOp","openParen","openBracket","question","colon"],A=function(){function e(t){(0,b.default)(this,e),this._grammar=t}return(0,x.default)(e,[{key:"getElements",value:function(e){var t=this._getSplitRegex();return e.split(t).filter((function(e){return e}))}},{key:"getTokens",value:function(e){for(var t=[],r=!1,n=0;n<e.length;n++)this._isWhitespace(e[n])?t.length&&(t[t.length-1].raw+=e[n]):"-"===e[n]&&this._isNegative(t)?r=!0:(r&&(e[n]="-"+e[n],r=!1),t.push(this._createToken(e[n])));return r&&t.push(this._createToken("-")),t}},{key:"tokenize",value:function(e){var t=this.getElements(e);return this.getTokens(t)}},{key:"_createToken",value:function(e){var t={type:"literal",value:e,raw:e};if('"'===e[0]||"'"===e[0])t.value=this._unquote(e);else if(e.match(g))t.value=parseFloat(e);else if("true"===e||"false"===e)t.value="true"===e;else if(this._grammar.elements[e])t.type=this._grammar.elements[e].type;else{if(!e.match(k))throw new Error("Invalid expression token: ".concat(e));t.type="identifier"}return t}},{key:"_escapeRegExp",value:function(e){return(e=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).match(k)&&(e="\\b"+e+"\\b"),e}},{key:"_getSplitRegex",value:function(){var e=this;if(!this._splitRegex){var t=Object.keys(this._grammar.elements).sort((function(e,t){return t.length-e.length})).map((function(t){return e._escapeRegExp(t)}),this);this._splitRegex=new RegExp("("+[E.join("|"),t.join("|"),w.join("|")].join("|")+")")}return this._splitRegex}},{key:"_isNegative",value:function(e){return!e.length||j.some((function(t){return t===e[e.length-1].type}))}},{key:"_isWhitespace",value:function(e){return!!e.match(O)}},{key:"_unquote",value:function(e){var t=e[0],r=new RegExp("\\\\"+t,"g");return e.substr(1,e.length-2).replace(r,t).replace(S,"\\")}}]),e}(),T={argVal:function(e){e&&this._cursor.args.push(e)},arrayStart:function(){this._placeAtCursor({type:"ArrayLiteral",value:[]})},arrayVal:function(e){e&&this._cursor.value.push(e)},binaryOp:function(e){for(var t=this._grammar.elements[e.value].precedence||0,r=this._cursor._parent;r&&r.operator&&this._grammar.elements[r.operator].precedence>=t;)this._cursor=r,r=r._parent;var n={type:"BinaryExpression",operator:e.value,left:this._cursor};this._setParent(this._cursor,n),this._cursor=r,this._placeAtCursor(n)},dot:function(){this._nextIdentEncapsulate=this._cursor&&"UnaryExpression"!==this._cursor.type&&("BinaryExpression"!==this._cursor.type||"BinaryExpression"===this._cursor.type&&this._cursor.right),this._nextIdentRelative=!this._cursor||this._cursor&&!this._nextIdentEncapsulate,this._nextIdentRelative&&(this._relative=!0)},filter:function(e){this._placeBeforeCursor({type:"FilterExpression",expr:e,relative:this._subParser.isRelative(),subject:this._cursor})},functionCall:function(){this._placeBeforeCursor({type:"FunctionCall",name:this._cursor.value,args:[],pool:"functions"})},identifier:function(e){var t={type:"Identifier",value:e.value};this._nextIdentEncapsulate?(t.from=this._cursor,this._placeBeforeCursor(t),this._nextIdentEncapsulate=!1):(this._nextIdentRelative&&(t.relative=!0,this._nextIdentRelative=!1),this._placeAtCursor(t))},literal:function(e){this._placeAtCursor({type:"Literal",value:e.value})},objKey:function(e){this._curObjKey=e.value},objStart:function(){this._placeAtCursor({type:"ObjectLiteral",value:{}})},objVal:function(e){this._cursor.value[this._curObjKey]=e},subExpression:function(e){this._placeAtCursor(e)},ternaryEnd:function(e){this._cursor.alternate=e},ternaryMid:function(e){this._cursor.consequent=e},ternaryStart:function(){this._tree={type:"ConditionalExpression",test:this._tree},this._cursor=this._tree},transform:function(e){this._placeBeforeCursor({type:"FunctionCall",name:e.value,args:[this._cursor],pool:"transforms"})},unaryOp:function(e){this._placeAtCursor({type:"UnaryExpression",operator:e.value})}},C={states:{expectOperand:{tokenTypes:{literal:{toState:"expectBinOp"},identifier:{toState:"identifier"},unaryOp:{},openParen:{toState:"subExpression"},openCurl:{toState:"expectObjKey",handler:T.objStart},dot:{toState:"traverse"},openBracket:{toState:"arrayVal",handler:T.arrayStart}}},expectBinOp:{tokenTypes:{binaryOp:{toState:"expectOperand"},pipe:{toState:"expectTransform"},dot:{toState:"traverse"},question:{toState:"ternaryMid",handler:T.ternaryStart}},completable:!0},expectTransform:{tokenTypes:{identifier:{toState:"postTransform",handler:T.transform}}},expectObjKey:{tokenTypes:{identifier:{toState:"expectKeyValSep",handler:T.objKey},closeCurl:{toState:"expectBinOp"}}},expectKeyValSep:{tokenTypes:{colon:{toState:"objVal"}}},postTransform:{tokenTypes:{openParen:{toState:"argVal"},binaryOp:{toState:"expectOperand"},dot:{toState:"traverse"},openBracket:{toState:"filter"},pipe:{toState:"expectTransform"}},completable:!0},postArgs:{tokenTypes:{binaryOp:{toState:"expectOperand"},dot:{toState:"traverse"},openBracket:{toState:"filter"},pipe:{toState:"expectTransform"}},completable:!0},identifier:{tokenTypes:{binaryOp:{toState:"expectOperand"},dot:{toState:"traverse"},openBracket:{toState:"filter"},openParen:{toState:"argVal",handler:T.functionCall},pipe:{toState:"expectTransform"},question:{toState:"ternaryMid",handler:T.ternaryStart}},completable:!0},traverse:{tokenTypes:{identifier:{toState:"identifier"}}},filter:{subHandler:T.filter,endStates:{closeBracket:"identifier"}},subExpression:{subHandler:T.subExpression,endStates:{closeParen:"expectBinOp"}},argVal:{subHandler:T.argVal,endStates:{comma:"argVal",closeParen:"postArgs"}},objVal:{subHandler:T.objVal,endStates:{comma:"expectObjKey",closeCurl:"expectBinOp"}},arrayVal:{subHandler:T.arrayVal,endStates:{comma:"arrayVal",closeBracket:"expectBinOp"}},ternaryMid:{subHandler:T.ternaryMid,endStates:{colon:"ternaryEnd"}},ternaryEnd:{subHandler:T.ternaryEnd,completable:!0}}},P=n(i),B=n(s),F=C.states,R=function(){function e(t,r,n){(0,P.default)(this,e),this._grammar=t,this._state="expectOperand",this._tree=null,this._exprStr=r||"",this._relative=!1,this._stopMap=n||{}}return(0,B.default)(e,[{key:"addToken",value:function(e){if("complete"===this._state)throw new Error("Cannot add a new token to a completed Parser");var t=F[this._state],r=this._exprStr;if(this._exprStr+=e.raw,t.subHandler){this._subParser||this._startSubExpression(r);var n=this._subParser.addToken(e);if(n){if(this._endSubExpression(),this._parentStop)return n;this._state=n}}else{if(!t.tokenTypes[e.type]){if(this._stopMap[e.type])return this._stopMap[e.type];throw new Error("Token ".concat(e.raw," (").concat(e.type,") unexpected in expression: ").concat(this._exprStr))}var a=t.tokenTypes[e.type],i=T[e.type];a.handler&&(i=a.handler),i&&i.call(this,e),a.toState&&(this._state=a.toState)}return!1}},{key:"addTokens",value:function(e){e.forEach(this.addToken,this)}},{key:"complete",value:function(){if(this._cursor&&!F[this._state].completable)throw new Error("Unexpected end of expression: ".concat(this._exprStr));return this._subParser&&this._endSubExpression(),this._state="complete",this._cursor?this._tree:null}},{key:"isRelative",value:function(){return this._relative}},{key:"_endSubExpression",value:function(){F[this._state].subHandler.call(this,this._subParser.complete()),this._subParser=null}},{key:"_placeAtCursor",value:function(e){this._cursor?(this._cursor.right=e,this._setParent(e,this._cursor)):this._tree=e,this._cursor=e}},{key:"_placeBeforeCursor",value:function(e){this._cursor=this._cursor._parent,this._placeAtCursor(e)}},{key:"_setParent",value:function(e,t){Object.defineProperty(e,"_parent",{value:t,writable:!0})}},{key:"_startSubExpression",value:function(t){var r=F[this._state].endStates;r||(this._parentStop=!0,r=this._stopMap),this._subParser=new e(this._grammar,t,r)}}]),e}(),V=n(i),M=n(s),I=function(){function e(t){(0,V.default)(this,e),t(this._resolve.bind(this),this._reject.bind(this))}return(0,M.default)(e,[{key:"catch",value:function(e){if(this.error)try{this._resolve(e(this.error))}catch(e){this._reject(e)}return this}},{key:"then",value:function(e,t){if(!this.error)try{this._resolve(e(this.value))}catch(e){this._reject(e)}return t&&this.catch(t),this}},{key:"_reject",value:function(e){this.value=void 0,this.error=e}},{key:"_resolve",value:function(t){t instanceof e?t.error?this._reject(t.error):this._resolve(t.value):(this.value=t,this.error=void 0)}}]),e}();I.all=function(e){return new I((function(t){t(e.map((function(e){for(;e instanceof I;){if(e.error)throw Error(e.error);e=e.value}return e})))}))},I.resolve=function(e){return new I((function(t){return t(e)}))},I.reject=function(e){return new I((function(t,r){return r(e)}))};var q=I,D=n(i),$=n(s),H=function(){function e(t,r){(0,D.default)(this,e),this._grammar=t,this._exprStr=r,this._ast=null}return(0,$.default)(e,[{key:"compile",value:function(){var e=new A(this._grammar),t=new R(this._grammar),r=e.tokenize(this._exprStr);return t.addTokens(r),this._ast=t.complete(),this}},{key:"eval",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this._eval(e,Promise)}},{key:"evalSync",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this._eval(e,q);if(t.error)throw t.error;return t.value}},{key:"_eval",value:function(e,t){var r=this;return t.resolve().then((function(){var n=r._getAst();return new m(r._grammar,e,void 0,t).eval(n)}))}},{key:"_getAst",value:function(){return this._ast||this.compile(),this._ast}}]),e}(),K=function(){return{elements:{".":{type:"dot"},"[":{type:"openBracket"},"]":{type:"closeBracket"},"|":{type:"pipe"},"{":{type:"openCurl"},"}":{type:"closeCurl"},":":{type:"colon"},",":{type:"comma"},"(":{type:"openParen"},")":{type:"closeParen"},"?":{type:"question"},"+":{type:"binaryOp",precedence:30,eval:function(e,t){return e+t}},"-":{type:"binaryOp",precedence:30,eval:function(e,t){return e-t}},"*":{type:"binaryOp",precedence:40,eval:function(e,t){return e*t}},"/":{type:"binaryOp",precedence:40,eval:function(e,t){return e/t}},"//":{type:"binaryOp",precedence:40,eval:function(e,t){return Math.floor(e/t)}},"%":{type:"binaryOp",precedence:50,eval:function(e,t){return e%t}},"^":{type:"binaryOp",precedence:50,eval:function(e,t){return Math.pow(e,t)}},"==":{type:"binaryOp",precedence:20,eval:function(e,t){return e==t}},"!=":{type:"binaryOp",precedence:20,eval:function(e,t){return e!=t}},">":{type:"binaryOp",precedence:20,eval:function(e,t){return e>t}},">=":{type:"binaryOp",precedence:20,eval:function(e,t){return e>=t}},"<":{type:"binaryOp",precedence:20,eval:function(e,t){return e<t}},"<=":{type:"binaryOp",precedence:20,eval:function(e,t){return e<=t}},"&&":{type:"binaryOp",precedence:10,evalOnDemand:function(e,t){return e.eval().then((function(e){return e?t.eval():e}))}},"||":{type:"binaryOp",precedence:10,evalOnDemand:function(e,t){return e.eval().then((function(e){return e||t.eval()}))}},in:{type:"binaryOp",precedence:20,eval:function(e,t){return"string"==typeof t?-1!==t.indexOf(e):!!Array.isArray(t)&&t.some((function(t){return t===e}))}},"!":{type:"unaryOp",precedence:1/0,eval:function(e){return!e}}},functions:{},transforms:{}}},z=n(a),L=n(i),U=n(s),Z=K,G=function(){function e(){(0,L.default)(this,e),this.expr=this.expr.bind(this),this._grammar=Z()}return(0,U.default)(e,[{key:"addBinaryOp",value:function(e,t,r,n){this._addGrammarElement(e,(0,z.default)({type:"binaryOp",precedence:t},n?"evalOnDemand":"eval",r))}},{key:"addFunction",value:function(e,t){this._grammar.functions[e]=t}},{key:"addFunctions",value:function(e){for(var t in e)this._grammar.functions[t]=e[t]}},{key:"addUnaryOp",value:function(e,t){this._addGrammarElement(e,{type:"unaryOp",weight:1/0,eval:t})}},{key:"addTransform",value:function(e,t){this._grammar.transforms[e]=t}},{key:"addTransforms",value:function(e){for(var t in e)this._grammar.transforms[t]=e[t]}},{key:"compile",value:function(e){return this.createExpression(e).compile()}},{key:"createExpression",value:function(e){return new H(this._grammar,e)}},{key:"getFunction",value:function(e){return this._grammar.functions[e]}},{key:"getTransform",value:function(e){return this._grammar.transforms[e]}},{key:"eval",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this.createExpression(e);return r.eval(t)}},{key:"evalSync",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this.createExpression(e);return r.evalSync(t)}},{key:"expr",value:function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];var a=e.reduce((function(e,t,n){return e+=t+(n<r.length?r[n]:"")}),"");return this.createExpression(a)}},{key:"removeOp",value:function(e){!this._grammar.elements[e]||"binaryOp"!==this._grammar.elements[e].type&&"unaryOp"!==this._grammar.elements[e].type||delete this._grammar.elements[e]}},{key:"_addGrammarElement",value:function(e,t){this._grammar.elements[e]=t}}]),e}(),J=new G,N=G;J.Jexl=N;export default J;export{N as Jexl,J as __moduleExports};
